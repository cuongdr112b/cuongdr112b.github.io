<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chi ti·∫øt s·∫£n ph·∫©m - ThriftC</title>
  <link rel="stylesheet" href="webchinh.css">
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<header>
  <div class="nav">
    <div class="logo"><a href="webchinh.html">ThriftC</a></div>
    <div class="nav-right">
      <!-- Mini gi·ªè h√†ng gi·ªëng trang ch√≠nh -->
      <div class="cart" id="cart">
        üõí <span>Gi·ªè</span>
        <span class="cart-count" id="cart-count">0</span>
        <div class="cart-dropdown" id="cart-dropdown">
          <div class="cart-items" id="cart-items"></div>
          <div class="cart-total">
            <span>T·ªïng:</span>
            <strong id="cart-total">0‚Ç´</strong>
          </div>
          <!-- ·ªû trang chi ti·∫øt, thanh to√°n v·∫´n d√πng logic ‚Äúorder ngay‚Äù -->
          <button type="button" class="btn-primary btn-cart-checkout" onclick="openCartPaymentFromDetail()">
            Thanh to√°n
          </button>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="product-detail fade-in">
  <div id="detail-wrapper" class="product-detail-content">
    <!-- JS s·∫Ω render n·ªôi dung chi ti·∫øt ·ªü ƒë√¢y -->
  </div>
</main>

<section class="related-section fade-in" id="related"></section>

<!-- Popup MUA NGAY (ch·ªâ 1 s·∫£n ph·∫©m hi·ªán t·∫°i) -->
<div class="modal" id="buy-modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeBuyModal()">√ó</span>
    <h2>Mua ngay</h2>
    <div id="buy-summary"></div>
    <p class="modal-note">Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n:</p>

    <div class="payment-options">
      <label class="pay-option">
        <input type="radio" name="buy-pay-method" value="Thanh to√°n khi nh·∫≠n" checked>
        <div class="pay-option-main">
          <div class="pay-option-header-row">
            <div class="pay-option-title">üíµ Thanh to√°n khi nh·∫≠n</div>
            <span class="pay-option-badge">Khuy√™n d√πng</span>
          </div>
          <div class="pay-option-desc">Tr·∫£ ti·ªÅn tr·ª±c ti·∫øp cho shipper khi nh·∫≠n h√†ng.</div>
        </div>
      </label>

      <label class="pay-option">
        <input type="radio" name="buy-pay-method" value="V√≠ Momo">
        <div class="pay-option-main">
          <div class="pay-option-title">üí∞ V√≠ Momo</div>
          <div class="pay-option-desc">Thanh to√°n nhanh b·∫±ng v√≠ Momo.</div>
        </div>
      </label>

      <label class="pay-option">
        <input type="radio" name="buy-pay-method" value="ATM n·ªôi ƒë·ªãa">
        <div class="pay-option-main">
          <div class="pay-option-title">üí≥ ATM n·ªôi ƒë·ªãa</div>
          <div class="pay-option-desc">Chuy·ªÉn kho·∫£n qua th·∫ª ng√¢n h√†ng n·ªôi ƒë·ªãa.</div>
        </div>
      </label>

      <label class="pay-option">
        <input type="radio" name="buy-pay-method" value="Visa / MasterCard">
        <div class="pay-option-main">
          <div class="pay-option-title">üí≥ Visa / MasterCard</div>
          <div class="pay-option-desc">Th·∫ª t√≠n d·ª•ng / ghi n·ª£ qu·ªëc t·∫ø.</div>
        </div>
      </label>
    </div>

    <!-- H∆∞·ªõng d·∫´n chi ti·∫øt theo ph∆∞∆°ng th·ª©c -->
    <div id="buy-payment-extra" style="margin-top:6px;"></div>

    <button id="buy-confirm-btn" class="btn-primary" onclick="confirmBuyNow()">
      X√°c nh·∫≠n thanh to√°n
    </button>
  </div>
</div>

<!-- TOAST (d√πng chung v·ªõi thriftc.js) -->
<div id="toast" class="toast" style="display:none;"></div>

<footer>
  <p>¬© 2025 ThriftC ¬∑ 2hand c≈© nh∆∞ng ch·∫•t.</p>
</footer>

<script src="products.js"></script>
<script src="thriftc.js"></script>
<script>
const products = ThriftC.products;

// L·∫•y id s·∫£n ph·∫©m t·ª´ URL
const id = parseInt(new URLSearchParams(location.search).get('id')) || 1;
const p  = products.find(x => x.id === id) || products[0];

// Render chi ti·∫øt s·∫£n ph·∫©m
function renderDetail() {
  const wrap = document.getElementById('detail-wrapper');
  wrap.innerHTML = `
    <img src="${p.img}" alt="${p.name}">
    <div class="product-info">
      <h1>${p.name}</h1>
      <p class="price">${ThriftC.formatPrice(p.price)}</p>
      <p class="desc">${p.desc}</p>
      <ul class="details-list">
        <li><strong>T√¨nh tr·∫°ng:</strong> 2hand - 9/10</li>
        <li><strong>Ch·∫•t li·ªáu:</strong> Cotton / Denim / N·ªâ</li>
        <li><strong>Size:</strong> M - L (fit oversize, unisex)</li>
        <li><strong>Vibe:</strong> Vintage ¬∑ Street ¬∑ Japan Style</li>
      </ul>
      <div class="detail-btns">
        <button class="btn-add dragon-btn" onclick="addToCartDetail(${p.id})">
          <span class="dragon-label">Th√™m v√†o gi·ªè</span>
          ${window.ThriftC && ThriftC.dragonSVG ? ThriftC.dragonSVG : ""}
        </button>
        <button class="btn-primary dragon-btn" onclick="openBuyModal()">
          <span class="dragon-label">Mua ngay</span>
          ${window.ThriftC && ThriftC.dragonSVG ? ThriftC.dragonSVG : ""}
        </button>
      </div>
    </div>
  `;
}

// S·∫£n ph·∫©m li√™n quan
function renderRelated() {
  const list = products.filter(x => x.id !== p.id);
  if (!list.length) return;
  let html = "<h2>S·∫£n ph·∫©m li√™n quan</h2><div class='related-grid'>";
  list.forEach(r => {
    html += `
      <div class="product-card">
        <img src="${r.img}" alt="${r.name}">
        <h3>${r.name}</h3>
        <p class="price">${ThriftC.formatPrice(r.price)}</p>
        <a href="webttqao.html?id=${r.id}" class="btn-buy dragon-btn">
          <span class="dragon-label">Xem ngay</span>
          ${window.ThriftC && ThriftC.dragonSVG ? ThriftC.dragonSVG : ""}
        </a>
      </div>`;
  });
  html += "</div>";
  document.getElementById('related').innerHTML = html;
}

// ========== TOAST (d√πng chung) ==========
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  t.classList.remove('hide');
  t.classList.add('show');
  setTimeout(()=> {
    t.classList.remove('show');
    t.classList.add('hide');
    setTimeout(()=>{ t.style.display='none'; }, 200);
  }, 2000);
}

// ================= GI·ªé H√ÄNG MINI (GI·ªêNG TRANG CH√çNH) =================
function addToCartDetail(pid) {
  const res = ThriftC.addToCart(pid);
  if(!res.added && res.reason === 'exists'){
    showToast('S·∫£n ph·∫©m n√†y ƒë√£ c√≥ trong gi·ªè üêâ');
  } else if(res.added){
    showToast('ƒê√£ th√™m v√†o gi·ªè h√†ng! üêâ');
  }
  updateCartUI();
}

function removeItem(id){
  ThriftC.removeFromCart(id);
  updateCartUI();
  showToast('ƒê√£ xo√° s·∫£n ph·∫©m kh·ªèi gi·ªè.');
}

function updateCartUI(){
  const cart = ThriftC.getCart();
  const count = document.getElementById('cart-count');
  const items = document.getElementById('cart-items');
  const total = document.getElementById('cart-total');
  let sum = 0;
  items.innerHTML = '';
  cart.forEach(i=>{
    sum += i.price * i.qty;
    items.innerHTML += `
      <div class="cart-item">
        <img src="${i.img}">
        <div style="flex:1">
          <p>${i.name}</p>
          <small>${i.qty} x ${ThriftC.formatPrice(i.price)}</small>
        </div>
        <button class="btn-remove" onclick="removeItem(${i.id})">‚ùå</button>
      </div>`;
  });
  count.textContent = cart.reduce((a,b)=>a+b.qty,0);
  total.textContent = ThriftC.formatPrice(sum);
}

// Hover dropdown gi·ªè h√†ng
const cartElem = document.getElementById('cart');
const dropdown = document.getElementById('cart-dropdown');
function showDropdown(){ dropdown.classList.add('visible'); }
function hideDropdownIfOut(){
  setTimeout(()=>{
    if(!cartElem.matches(':hover') && !dropdown.matches(':hover')){
      dropdown.classList.remove('visible');
    }
  },120);
}
cartElem.addEventListener('mouseenter',showDropdown);
cartElem.addEventListener('mouseleave',hideDropdownIfOut);
dropdown.addEventListener('mouseenter',showDropdown);
dropdown.addEventListener('mouseleave',hideDropdownIfOut);

// ================== ƒêI·ªÄU KI·ªÜN MUA H√ÄNG ==================
function ensureCanCheckoutDetail() {
  const user = ThriftC.getCurrentUser();
  if(!user){
    showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi mua h√†ng.');
    setTimeout(()=>{ window.location.href = 'dangnhap.html'; }, 600);
    return false;
  }
  const info = ThriftC.getCustomerInfo();
  if(!ThriftC.isCustomerInfoComplete(info)){
    showToast('B·∫°n c·∫ßn c·∫≠p nh·∫≠t ƒë·∫ßy ƒë·ªß "Th√¥ng tin kh√°ch h√†ng" ·ªü trang ch√≠nh tr∆∞·ªõc khi mua h√†ng.');
    return false;
  }
  return true;
}

// ======= TR·∫†NG TH√ÅI THANH TO√ÅN MUA NGAY =======
const buyPaymentState = {
  method: 'Thanh to√°n khi nh·∫≠n',
  step: 'select'
};

// H∆∞·ªõng d·∫´n chi ti·∫øt cho t·ª´ng ph∆∞∆°ng th·ª©c trong MUA NGAY
function updateBuyPaymentExtra(){
  const selected = document.querySelector('input[name="buy-pay-method"]:checked');
  const extra = document.getElementById('buy-payment-extra');
  if(!selected || !extra) return;
  const method = selected.value;
  buyPaymentState.method = method;
  buyPaymentState.step = 'select';

  if(method === 'V√≠ Momo'){
    extra.style.display = 'block';
    extra.innerHTML = `
      <h4 style="margin:0 0 6px; color:#eab308; font-size:1rem;">Thanh to√°n b·∫±ng Momo</h4>
      <p style="margin:2px 0; font-size:0.85rem; color:#e5e7eb;">
        Qu√©t m√£ QR d∆∞·ªõi ƒë√¢y b·∫±ng ·ª©ng d·ª•ng Momo v√† nh·∫≠p <strong>ƒë√∫ng s·ªë ti·ªÅn</strong> c·ªßa ƒë∆°n h√†ng.
      </p>
      <img src="img/momo-qr-nguyen-manh-cuong.png"
           alt="QR Momo"
           style="display:block;margin:6px auto 4px;width:170px;height:170px;border-radius:12px;border:1px solid rgba(234,179,8,0.4);object-fit:cover;">
      <p style="margin:2px 0; font-size:0.8rem; color:#9ca3af;">
        Sau khi thanh to√°n xong, h√£y b·∫•m n√∫t <strong>ƒê√£ thanh to√°n</strong> ƒë·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.
      </p>
    `;
  } else if(method === 'ATM n·ªôi ƒë·ªãa'){
    extra.style.display = 'block';
    extra.innerHTML = `
      <h4 style="margin:0 0 6px; color:#eab308; font-size:1rem;">Thanh to√°n b·∫±ng th·∫ª ATM n·ªôi ƒë·ªãa</h4>
      <p style="margin:2px 0; font-size:0.85rem; color:#e5e7eb;">
        Vui l√≤ng chuy·ªÉn kho·∫£n theo th√¥ng tin:
      </p>
      <p style="margin:2px 0; font-size:0.85rem;">
        <strong>Ng√¢n h√†ng:</strong> ABC Bank<br>
        <strong>S·ªë t√†i kho·∫£n:</strong> 1234 5678 999<br>
        <strong>Ch·ªß t√†i kho·∫£n:</strong> NGUY·ªÑN M·∫†NH C∆Ø·ªúNG<br>
        <strong>N·ªôi dung:</strong> THRIFTC - SƒêT c·ªßa b·∫°n
      </p>
      <p style="margin:2px 0; font-size:0.8rem; color:#9ca3af;">
        Sau khi chuy·ªÉn kho·∫£n, b·∫•m <strong>ƒê√£ thanh to√°n</strong> ƒë·ªÉ ho√†n th√†nh ƒë·∫∑t h√†ng.
      </p>
    `;
  } else if(method === 'Visa / MasterCard'){
    extra.style.display = 'block';
    extra.innerHTML = `
      <h4 style="margin:0 0 6px; color:#eab308; font-size:1rem;">Thanh to√°n b·∫±ng Visa / MasterCard</h4>
      <p style="margin:2px 0; font-size:0.85rem; color:#e5e7eb;">
        H·ªá th·ªëng thanh to√°n th·∫ª qu·ªëc t·∫ø ƒëang ƒë∆∞·ª£c ho√†n thi·ªán.
      </p>
      <p style="margin:2px 0; font-size:0.85rem;">
        Trong th·ªùi gian n√†y, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng <strong>Thanh to√°n khi nh·∫≠n</strong> ho·∫∑c
        chuy·ªÉn kho·∫£n qua <strong>Momo / ATM n·ªôi ƒë·ªãa</strong>.
      </p>
    `;
  } else {
    extra.style.display = 'none';
    extra.innerHTML = '';
  }

  const btn = document.getElementById('buy-confirm-btn');
  if(btn) btn.textContent = 'X√°c nh·∫≠n thanh to√°n';
}

// ============== MUA NGAY (CH·ªà 1 S·∫¢N PH·∫®M N√ÄY) ==============
function openBuyModal() {
  if(!ensureCanCheckoutDetail()) return;

  const box = document.getElementById('buy-summary');
  box.innerHTML = `
    <div class="cart-item">
      <img src="${p.img}">
      <div>
        <p>${p.name}</p>
        <small>1 x ${ThriftC.formatPrice(p.price)}</small>
      </div>
    </div>
    <div class="cart-total" style="margin-top:8px;">
      <span>T·ªïng:</span>
      <strong>${ThriftC.formatPrice(p.price)}</strong>
    </div>
  `;

  buyPaymentState.step = 'select';
  const btn = document.getElementById('buy-confirm-btn');
  if(btn) btn.textContent = 'X√°c nh·∫≠n thanh to√°n';

  document.getElementById('buy-modal').style.display = 'flex';
  updateBuyPaymentExtra();
}

function closeBuyModal() {
  document.getElementById('buy-modal').style.display = 'none';
  buyPaymentState.step = 'select';
}

function confirmBuyNow() {
  if(!ensureCanCheckoutDetail()) return;

  let method = '';
  document.querySelectorAll('input[name="buy-pay-method"]').forEach(r=>{
    if(r.checked) method = r.value;
  });
  if(!method){
    showToast('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.');
    return;
  }

  const info = ThriftC.getCustomerInfo();

  // COD: t·∫°o ƒë∆°n lu√¥n
  if(method === 'Thanh to√°n khi nh·∫≠n'){
    const order = {
      id: Date.now(),
      date: new Date().toLocaleString('vi-VN'),
      items: [{ ...p, qty: 1 }],
      total: p.price,
      payment: method,
      customer: info,
      status: 'ƒêang x·ª≠ l√Ω'
    };
    ThriftC.saveOrder(order);
    showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng! Xem trong L·ªãch s·ª≠ ƒë∆°n h√†ng.');
    closeBuyModal();
    return;
  }

  // Chuy·ªÉn kho·∫£n: 2 b∆∞·ªõc
  if(buyPaymentState.step === 'select'){
    buyPaymentState.step = 'confirm';
    const btn = document.getElementById('buy-confirm-btn');
    if(btn) btn.textContent = 'ƒê√£ thanh to√°n - Ho√†n t·∫•t ƒë∆°n';
    showToast(`Vui l√≤ng thanh to√°n qua ${method}, sau ƒë√≥ b·∫•m "ƒê√£ thanh to√°n - Ho√†n t·∫•t ƒë∆°n".`);
    return;
  }

  const order = {
    id: Date.now(),
    date: new Date().toLocaleString('vi-VN'),
    items: [{ ...p, qty: 1 }],
    total: p.price,
    payment: method,
    customer: info,
    status: 'ƒêang x·ª≠ l√Ω'
  };

  ThriftC.saveOrder(order);
  showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ thanh to√°n.');
  closeBuyModal();
}

// ========== THANH TO√ÅN T·ª™ GI·ªé H√ÄNG ·ªû TRANG CHI TI·∫æT ==========
function openCartPaymentFromDetail(){
  if(!ensureCanCheckoutDetail()) return;
  const cart = ThriftC.getCart();
  if(cart.length === 0){
    showToast('Gi·ªè h√†ng tr·ªëng.');
    return;
  }

  const info = ThriftC.getCustomerInfo();
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);

  const method = 'Thanh to√°n khi nh·∫≠n';

  const order = {
    id: Date.now(),
    date: new Date().toLocaleString('vi-VN'),
    items: cart,
    total,
    payment: method,
    customer: info,
    status: 'ƒêang x·ª≠ l√Ω'
  };

  ThriftC.saveOrder(order);
  ThriftC.clearCart();
  updateCartUI();
  showToast('ƒê·∫∑t h√†ng th√†nh c√¥ng t·ª´ gi·ªè! Ki·ªÉm tra L·ªãch s·ª≠ ƒë∆°n h√†ng nh√©.');
}

// G·∫Øn event cho radio mua ngay
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('input[name="buy-pay-method"]').forEach(r => {
    r.addEventListener('change', updateBuyPaymentExtra);
  });
  updateBuyPaymentExtra();
});

// Kh·ªüi t·∫°o
renderDetail();
renderRelated();
updateCartUI();
</script>
</body>
</html>
