<!DOCTYPE html> 
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thanh to√°n - ThriftC</title>
<link rel="stylesheet" href="webchinh.css">
<script src="products.js"></script>
<script src="thriftc.js"></script>
</head>
<body>
<header>
  <div class="nav">
    <div class="logo"><a href="webchinh.html">ThriftC</a></div>
  </div>
</header>

<main class="checkout fade-in">
  <h1>Thanh to√°n ƒë∆°n h√†ng</h1>
  <div class="checkout-grid">
    <div class="checkout-left">
      <h3>Th√¥ng tin giao h√†ng</h3>
      <input type="text" id="name" placeholder="H·ªç v√† t√™n">
      <input type="text" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i">
      <input type="text" id="email" placeholder="Email (@gmail.com)">
      <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n h√†ng">

      <!-- PH·∫¶N PH∆Ø∆†NG TH·ª®C THANH TO√ÅN ƒê√É ƒê∆Ø·ª¢C L√ÄM L·∫†I -->
      <h3 style="margin-top: 12px;">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
      <div class="payment-options" id="payment-options">
        <label>
          <input type="radio" name="payment" value="atm" data-label="üí≥ ATM n·ªôi ƒë·ªãa" checked>
          <span>üí≥ ATM n·ªôi ƒë·ªãa</span>
        </label>
        <label>
          <input type="radio" name="payment" value="visa" data-label="üí≥ Visa / MasterCard">
          <span>üí≥ Visa / MasterCard</span>
        </label>
        <label>
          <input type="radio" name="payment" value="momo" data-label="üí∞ V√≠ Momo">
          <span>üí∞ V√≠ Momo</span>
        </label>
        <label>
          <input type="radio" name="payment" value="cod" data-label="üíµ Thanh to√°n khi nh·∫≠n">
          <span>üíµ Thanh to√°n khi nh·∫≠n</span>
        </label>
      </div>

      <!-- Ghi ch√∫ thay ƒë·ªïi theo ph∆∞∆°ng th·ª©c -->
      <p class="modal-note" id="payment-note"></p>

      <input type="text" id="coupon" placeholder="Nh·∫≠p m√£ gi·∫£m gi√° (n·∫øu c√≥)">

      <button class="btn-primary dragon-btn" onclick="placeOrder()">
        <span class="dragon-label">Ho√†n t·∫•t ƒë·∫∑t h√†ng</span>
        <svg class="dragon-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 32C18 20 30 18 40 22C48 25 54 32 56 40C50 38 44 38 40 40C34 43 30 48 28 56C24 50 20 46 14 44C10 42 8 38 8 32Z"
                fill="none" stroke="#eab308" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M36 20C38 18 40 16 42 14" stroke="#b91c1c" stroke-width="2.2" stroke-linecap="round"/>
          <circle cx="44" cy="18" r="2" fill="#fefce8"/>
        </svg>
      </button>
    </div>

    <div class="checkout-right">
      <h3>ƒê∆°n h√†ng c·ªßa b·∫°n</h3>
      <div class="cart-summary" id="cart-summary">
        <p>Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng.</p>
      </div>
    </div>
  </div>
</main>

<div id="success-popup" class="success-popup">
  <div class="popup-box">
    <h2>‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng!</h2>
    <p>C·∫£m ∆°n b·∫°n ƒë√£ mua s·∫Øm t·∫°i <strong>ThriftC</strong>.<br>
    ƒê∆°n h√†ng c·ªßa b·∫°n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.</p>
    <button class="btn-primary" onclick="window.location.href='orders.html'">Xem l·ªãch s·ª≠ ƒë∆°n h√†ng</button>
    <button class="btn-primary" onclick="window.location.href='webchinh.html'">V·ªÅ trang ch·ªß</button>
  </div>
</div>

<footer>
  <p>¬© 2025 ThriftC ¬∑ Thanh to√°n an to√†n ¬∑ B·∫£o m·∫≠t th√¥ng tin kh√°ch h√†ng</p>
</footer>

<script>
const cartData = ThriftC.getCart();
const cartSummary = document.getElementById('cart-summary');

/* Render gi·ªè h√†ng b√™n ph·∫£i */
function renderCart() {
  if (!cartData || cartData.length === 0) {
    cartSummary.innerHTML = '<p>Gi·ªè h√†ng c·ªßa b·∫°n tr·ªëng.</p>';
    return;
  }
  let total = 0;
  let html = '';
  cartData.forEach(item => {
    const subtotal = item.price * item.qty;
    total += subtotal;
    html += `
      <div class="cart-item">
        <img src="${item.img}" alt="${item.name}">
        <div>
          <p>${item.name}</p>
          <small>${item.qty} x ${ThriftC.formatPrice(item.price)}</small>
        </div>
        <div style="margin-left:auto; font-weight:600;">
          ${ThriftC.formatPrice(subtotal)}
        </div>
      </div>`;
  });
  const shipping = 30000;
  const grandTotal = total + shipping;
  html += `
    <hr>
    <p>Ph√≠ giao h√†ng: <strong>${ThriftC.formatPrice(shipping)}</strong></p>
    <div class="cart-total">
      <span>T·ªïng c·ªông:</span>
      <strong>${ThriftC.formatPrice(grandTotal)}</strong>
    </div>`;
  cartSummary.innerHTML = html;
}

/* C·∫≠p nh·∫≠t ghi ch√∫ theo ph∆∞∆°ng th·ª©c thanh to√°n */
function updatePaymentNote() {
  const selected = document.querySelector('input[name="payment"]:checked');
  const noteEl = document.getElementById('payment-note');
  if (!selected || !noteEl) return;

  let note = '';
  switch (selected.value) {
    case 'atm':
      note = 'Thanh to√°n b·∫±ng th·∫ª ATM n·ªôi ƒë·ªãa qua c·ªïng thanh to√°n an to√†n.';
      break;
    case 'visa':
      note = 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng / ghi n·ª£ Visa, MasterCard.';
      break;
    case 'momo':
      note = 'Qu√©t m√£ ho·∫∑c thanh to√°n tr·ª±c ti·∫øp qua v√≠ Momo.';
      break;
    case 'cod':
      note = 'Thanh to√°n khi nh·∫≠n h√†ng (COD) ‚Äì b·∫°n tr·∫£ ti·ªÅn cho shipper khi nh·∫≠n h√†ng.';
      break;
    default:
      note = '';
  }
  noteEl.textContent = note;
}

/* H√†m ƒë·∫∑t h√†ng */
function placeOrder() {
  if (!cartData || cartData.length === 0) {
    alert('Gi·ªè h√†ng tr·ªëng, kh√¥ng th·ªÉ ƒë·∫∑t h√†ng.');
    return;
  }

  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const email = document.getElementById('email').value.trim();
  const address = document.getElementById('address').value.trim();
  const paymentInput = document.querySelector('input[name="payment"]:checked');
  const payment = paymentInput ? paymentInput.getAttribute('data-label') : '';

  if (!name || !phone || !email || !address || !payment) {
    alert('‚ö†Ô∏è Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng v√† ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
    return;
  }

  if (!ThriftC.validators.isValidName(name)) {
    alert('‚ùå H·ªç v√† t√™n ch·ªâ ƒë∆∞·ª£c ch·ª©a k√Ω t·ª± ch·ªØ (kh√¥ng s·ªë, kh√¥ng k√Ω hi·ªáu).');
    return;
  }
  if (!ThriftC.validators.isValidPhone(phone)) {
    alert('‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ch·ªâ g·ªìm 9-11 ch·ªØ s·ªë).');
    return;
  }
  if (!ThriftC.validators.isValidEmail(email)) {
    alert('‚ùå Email ph·∫£i c√≥ d·∫°ng h·ª£p l·ªá, v√≠ d·ª•: tenban@gmail.com');
    return;
  }

  let total = 0;
  cartData.forEach(i => { total += i.price * i.qty; });
  const shipping = 30000;
  const grandTotal = total + shipping;

  const orders = JSON.parse(localStorage.getItem('thriftc_orders')) || [];
  const order = {
    id: Date.now(),
    date: new Date().toLocaleString('vi-VN'),
    items: cartData,
    total: grandTotal,
    shipping,
    payment,   // v·∫´n l∆∞u ƒë√∫ng text: "üíµ Thanh to√°n khi nh·∫≠n"...
    name,
    phone,
    email,
    address,
    status: 'ƒêang x·ª≠ l√Ω'
  };
  orders.push(order);
  localStorage.setItem('thriftc_orders', JSON.stringify(orders));
  localStorage.removeItem('thriftc_cart');

  document.getElementById('success-popup').style.display = 'flex';
}

/* Kh·ªüi t·∫°o khi load trang */
document.addEventListener('DOMContentLoaded', function () {
  renderCart();
  updatePaymentNote();

  document.addEventListener('change', function (e) {
    if (e.target.matches('input[name="payment"]')) {
      updatePaymentNote();
    }
  });
});
</script>
</body>
</html>
